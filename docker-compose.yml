version: "3.3"
services:
  nginx-server:
    image: nginx:latest
    volumes:
      - ./services/nginx/nginx.conf:/etc/nginx/nginx.conf
      - /etc/letsencrypt/:/etc/letsencrypt/
    ports:
      - 443:443
      - 80:80

  nuxt-server:
    build: services/nuxt
    ports:
    - "3000:3000"
    env_file:
    - ".nuxt.env"
    command: "npm run dev"

  django-server:
    build: 
      context: .
      dockerfile: services/django/Dockerfile
    ports:
    - "8000:8000"
    env_file:
      - .django.env
    healthcheck:
      test: "curl -sS http://django-server:8000 || exit 1"
      interval: "60s"
      timeout: "3s"
      retries: 3
    depends_on:
    - postgres-server
    command: ./django_entry.sh

  postgres-server:
    build: services/postgres
    ports:
    - "5432:5432"
    environment:
      POSTGRES_DB_NAME: drumrose_db
      POSTGRES_USER: drumrose_user
      POSTGRES_PASSWORD: drumrose_password
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U drumrose_user"]
      interval: 3s
      timeout: 30s
      retries: 3
    volumes:
      - /var/lib/postgresql/:/var/lib/postgresql/
  
  tests-server:
    build:
      context: .
      dockerfile: tests/Dockerfile
    command: "tail -f /dev/null"

  musicbrainz:
    image: linuxserver/musicbrainz
    container_name: musicbrainz
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      - BRAINZCODE=code from musicbrainz
      - WEBADDRESS=ip of host
      - NPROC=parameter #optional
    volumes:
      - /path/to/appdata/config:/config
      - /path/to/appdata/config:/data
    ports:
      - 5000:5000
    restart: unless-stopped
